FROM hhcmhub/xbot2-noble-dev
# Build arguments
ARG USER_ID=1000
ARG KERNEL_VER=0
ARG USER_NAME=user
ARG ROBOT_NAME=robot
ENV ROBOT_NAME=${ROBOT_NAME}
ARG RECIPES_TAG=main
ARG ROBOT_PACKAGES=""
ARG ADDITIONAL_PACKAGES=""

# ROS2 DDS Configuration arguments
ARG ROS_DDS_VENDOR=cyclonedds
ARG ROS_IP=localhost
ARG SETUP_ROS2_DDS=true

# env
ENV PYTHONUNBUFFERED=1

# additional dependencies
RUN sudo sh -c 'echo "deb http://xbot.cloud/xbot2-nightly/ubuntu/$(lsb_release -sc) /" > /etc/apt/sources.list.d/xbot-latest.list' && \
    wget -q -O - http://xbot.cloud/xbot2/ubuntu/KEY.gpg | sudo apt-key add -

# FIX 1: Add the new ROS GPG key
RUN sudo apt-get update && sudo apt-get install -y curl && \
    sudo curl -sSL https://raw.githubusercontent.com/ros/rosdistro/master/ros.key -o /usr/share/keyrings/ros-archive-keyring.gpg

RUN sudo apt update && sudo apt install -y xbot2_desktop_full ros-$ROS_DISTRO-realsense2-description

# add kyon user
USER root

RUN echo "$USER_NAME:user" | chpasswd

WORKDIR /home/$USER_NAME

# bashrc
COPY --chown=$USER_NAME scripts /home/$USER_NAME/scripts
RUN cp /etc/skel/.bashrc .
RUN bash -c "echo source /home/${USER_NAME}/scripts/env.bash >> /home/$USER_NAME/.bashrc"

# env
RUN python3 -m venv --system-site-packages env 

# set ownership to user for the whole home folder 
RUN chown -R $USER_NAME .

# switch to user
USER $USER_NAME
SHELL [ "/bin/bash", "-ic" ]

# configure forest to use https
ENV HHCM_FOREST_CLONE_DEFAULT_PROTO=https

# pip deps
RUN source ~/env/bin/activate && pip install netifaces

# ROS2 DDS Configuration 
RUN if [ "$SETUP_ROS2_DDS" = "true" ]; then \
        sudo apt-get update && sudo apt-get install -y cmake build-essential; \
    fi

# Conditionally setup ROS2 DDS configuration
RUN if [ "$SETUP_ROS2_DDS" = "true" ]; then \
        git clone https://github.com/advrhumanoids/ros2_config.git /tmp/ros2_config && \
        cd /tmp/ros2_config && \
        mkdir build && cd build && \
        cmake .. -DROS2_IP=$ROS_IP && \
        make && \
        sudo make install && \
        echo "source ~/ros2_config/dds/${ROS_DDS_VENDOR}/setup.bash" >> ~/.bashrc && \
        cd / && rm -rf /tmp/ros2_config; \
    fi

# Also set the RMW implementation if using CycloneDDS
RUN if [ "$ROS_DDS_VENDOR" = "cyclonedds" ]; then \
        echo "export RMW_IMPLEMENTATION=rmw_cyclonedds_cpp" >> ~/.bashrc; \
    fi
# END ROS2 DDS CONFIGURATION

# build required software (requires valid netrc for auth)
# FIX 2: Activate env before running build script 
RUN --mount=type=secret,id=netrc,dst=/home/$USER_NAME/.netrc,uid=$USER_ID \
    /bin/bash scripts/build-base.bash
